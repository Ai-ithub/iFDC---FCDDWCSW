# -*- coding: utf-8 -*-
"""ZScore_replaceOutlier.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1yQajXqQvlJhONjfdcVoHZ4oekARp8ljZ
"""

from google.colab import drive
drive.mount('/content/mydrive')

!pip install pandas pyarrow
!pip install pandas fastparquet

import pandas as pd
import numpy as np
from scipy import stats

# خواندن داده‌ها از فایل CSV
input_file = '//content//mydrive//MyDrive//Colab Notebooks//formation_damage_optimized.parquet' # نام فایل ورودی
output_cleaned = '//content//mydrive//MyDrive//Colab Notebooks//cleaned_data_zscore.csv'
output_removed = '//content//mydrive//MyDrive//Colab Notebooks//removed_outliers_zscore.csv'

df = pd.read_parquet(input_file)

# ستون‌های مورد نظر برای آنالیز
columns_to_check = ['Temperature_C', 'Pressure_psi', 'Permeability_mD', 'Flow_Rate_bbl_day']

# ذخیره مقادیر پرت و جایگزینی آنها
replaced_values_list = []

# تعریف تابع تشخیص پرت با روش Z-Score و جایگزینی
def replace_outliers_with_zscore(df, column, threshold=3, method='median'):
    df = df.copy()
    z_scores = np.abs(stats.zscore(df[[column]]))
    outliers_mask = (z_scores[:, 0] > threshold)
    outliers = df[outliers_mask]

    if method == 'median':
        replacement_value = df[column].median()
    elif method == 'mean':
        replacement_value = df[column].mean()
    else:
        raise ValueError("روش جایگزینی باید 'median' یا 'mean' باشد.")

    # جایگزینی مقادیر پرت
    df.loc[outliers_mask, column] = replacement_value

    # ثبت مقادیر پرت و مقدار جایگزین
    for _, row in outliers.iterrows():
        replaced_row = row.to_dict()
        replaced_row['Replaced_Value'] = replacement_value
        replaced_row['Method'] = method
        replaced_values_list.append(replaced_row)

    return df, replaced_values_list

# پردازش هر ستون
for col in columns_to_check:
    if col not in df.columns:
        print(f" ستون '{col}' وجود ندارد و از پردازش حذف شد.")
        continue

    print(f"\n پردازش ستون: {col}")
    df, replaced_values_list = replace_outliers_with_zscore(df, col, threshold=3, method='median')

# ذخیره داده‌های تمیز شده
df.to_csv(output_cleaned, index=False)
print(f"\ داده‌های اصلاح‌شده در فایل '{output_cleaned}' ذخیره شد.")

# ساخت DataFrame از لیست مقادیر پرت و جایگزینی‌شده
if replaced_values_list:
    replaced_df = pd.DataFrame(replaced_values_list)
    replaced_df.to_csv(output_removed, index=False)
    print(f" لیست مقادیر پرت و جایگزینی‌شده در فایل '{output_removed}' ذخیره شد.")
else:
    print(" هیچ مقدار پرتی یافت نشد.")

